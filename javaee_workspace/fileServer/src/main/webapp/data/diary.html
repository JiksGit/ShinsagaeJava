<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Document</title>
  <link rel="stylesheet" href="style.css">
  <script src="./js/Cell.js"></script>
  <script src="./js/MiniCell.js"></script>
  <script src="./js/DiaryCell.js"></script>
  <script src="./js/common.js"></script>
  <script src="./js/crud.js"></script>
  <script src="./js/printOrCreate.js"></script>
  <script src="./js/googleMap.js"></script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCe4PUIorwSDpG3ZZPLxaPjbWW4ICuNpFM&libraries=places" async defer></script>

  <script>
    let cellArray = Array.from({ length: 6 }, () => Array(7).fill(0));
    let minicellArray = Array.from({ length: 6 }, () => Array(7).fill(0));
    let restArray = []; // ê³µíœ´ì¼ ë°°ì—´
    let diaryArray = []; // ì‚¬ìš©ì plan ë°°ì—´
    let currentYear;
    let currentMonth;
    let miniCurrentYear;
    let miniCurrentMonth;
    let currentCell;
    let st;
    
    // ìˆ¨ê²¨ì ¸ ìˆë˜, ëŒ€í™”ì°½ì„ ë„ìš°ë˜, ê·¸ ìœ„ì¹˜ëŠ” ì§€ê¸ˆ í´ë¦­í•œ ë°”ë¡œ ê·¸ ì…€ì˜ x,yë¥¼
    // ë”°ë¼ê°€ì•¼í•¨..
    function openDialog(obj) {
      // í˜„ì¬ ë‹¤ì´ì–´ë¡œê·¸ì— ëŒ€í•œ objê°’
        let dialog = document.getElementById("dialog");
        dialog.style.display = "block";
        
        // íŒì—…ì˜ ìœ„ì¹˜ëŠ” ì‚¬ìš©ìê°€ í´ë¦­í•œ ì…€ì˜ ì¢Œí‘œ ë°”ë¡œ ì•„ë˜ì¹¸ì—  ì¼ì¹˜ì‹œí‚¤ì
        dialog.style.left = obj.x + "px";
        dialog.style.top = obj.y + "px";
        dialog.style.background = "gray";
        
        // ë„˜ê²¨ë°›ì€ x, yë¥¼ ì´ìš©í•˜ì—¬ ìƒˆ ì°½ì˜ ìœ„ì¹˜ë¥¼ ê²°ì •ì§“ì
        dialog.style.position = "absolute";
        dialog.style.zIndex = 9999; // ë§¨ ì•ìœ¼ë¡œ ì´ë™ - zIndex

        dialog.querySelector(".mini-popup h4").textContent = "ì¼ì •";

        dialog.querySelector(".mini-popup .info:nth-of-type(1)").innerHTML = `
          <span class="label">ì œëª©:</span><br />
          ${obj.title || "ì œëª© ì—†ìŒ"}
        `;

        dialog.querySelector(".mini-popup .info:nth-of-type(2)").innerHTML = `
          <span class="label">ì¥ì†Œ:</span><br />
          ${obj.place || "ì¥ì†Œ ì—†ìŒ"}
        `;
        //  ì§€ë„ ì¶œë ¥
        const geocoder = new google.maps.Geocoder();
        const place = obj.place || ""; // ê°•ë‚¨êµ¬

        if (place !== "") {
          document.getElementById("map").style.display= "block";
          geocoder.geocode({ address: place }, (results, status) => {
            if (status === "OK") {
              // geocoderê°€ ë°˜í™˜í•´ì¤€ resultsì˜ geometry ì •ë³´ ì¤‘ location ì €ì¥
              const location = results[0].geometry.location; 

              // map ì¶œë ¥
              const map = new google.maps.Map(document.getElementById("map"), {
                center: location,
                zoom: 13,
                disableDefaultUI: true
              });

              // ë§µì˜ í˜„ì¬ ì§€ì—­ ë§ˆì»¤ ì¶œë ¥
              new google.maps.Marker({
                map: map,
                animation: google.maps.Animation.DROP,
                icon: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png",
                position: location,
                title: place,
              });

              // ajaxë¡œ ì„œìš¸íŠ¹ë³„ì‹œ ë§›ì§‘ json ë°ì´í„°ë¥¼ ë¹„ë™ê¸°ì ìœ¼ë¡œ ì²˜ë¦¬
              fetch("./seoulFood.json")
                .then(res => res.json())
                .then(json => {
                  // jsonì¤‘ì—ì„œ place ì´ë¦„ì´ í¬í•¨ëœ ë¶€ë¶„ë§Œ ë°œì·Œ
                  let filtered = filterByWord(json, place);

                  // 
                  geocodeDistrict(place, (location) => {
                    map.setCenter(location);
                    showMarkersOnMap(filtered, map);
                  })
                })
            } 
            else {
              console.warn("Geocoding ì‹¤íŒ¨:", status);
              document.getElementById("map").innerHTML = "<p style='color:white;'>ì§€ë„ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</p>";
            }
          });
        } else {
          document.getElementById("map").innerHTML = "<p style='color:white;'>ì¥ì†Œ ì •ë³´ ì—†ìŒ</p>";
          document.getElementById("map").style.display= "none";
        }

        dialog.querySelector(".mini-popup .info:nth-of-type(3)").innerHTML = `
          <span class="label">ë©”ëª¨:</span><br />
          ${obj.description || "ë©”ëª¨ ì—†ìŒ"}
        `;

        // ë©”ëª¨ì—ì„œ ìƒì„¸í˜ì´ì§€ ë³´ì—¬ì£¼ê¸°
     document.getElementById("detail-dial").addEventListener("click", () => {
      formPrint(obj); // â¬… í¼ ë¨¼ì € ë³´ì—¬ì£¼ê³ 

      setTimeout(() => {
        document.querySelector('input[name="title"]').value = obj.title;
        document.querySelector('textarea[name="description"]').value = obj.description;
        document.querySelector('select[name="place"]').value = obj.place;
        document.querySelector('select[name="year"]').value = obj.year;
        document.querySelector('select[name="month"]').value = obj.month + 1;
        document.querySelector('select[name="date"]').value = obj.date;
        document.querySelector('select[name="color"]').value = obj.bg;

        document.getElementById("update_diary").onclick = () => {
          update(obj);
        };

        // ë²„íŠ¼ ìƒíƒœ ì„¤ì •
        document.getElementById("update_diary").style.display = "block";
        document.getElementById("save_diary").style.display = "none";

      }, 10); // ì•½ê°„ì˜ ì§€ì—° â†’ DOM ë°˜ì˜ ì´í›„ ì‹¤í–‰
    });
    }

    function restPrint(){
    let tag = "<table>";
    tag += "<tr><th>ì›”</th><th>ì¼</th><th>ì´ë¦„</th></tr>";

    for(let i=0; i < restArray.length; i++){
      let rest = restArray[i];
      tag += "<tr>";
        tag += `<td style="color:red">${rest.month + 1}</td>`;
        tag += `<td style="color:red">${rest.date}</td>`;
        tag += `<td style="color:black">${rest.title}</td>`;
        tag += "</tr>";
      }
      
      tag += "</table>";
      document.getElementById("rest-div").innerHTML = tag;
    }
    
    function diaryPrint(){
      let tag = "<table>";
      tag += "<tr><th>ì›”</th><th>ì¼</th><th>ì´ë¦„</th></tr>";
      
      diaryArray.sort((a, b) => {
        if(a.month == b.month) return a.date - b.date;
        else return a.month - b.month;
      });
      for(let i=0; i < diaryArray.length; i++){
        let diary = diaryArray[i];
        tag += "<tr>";
          tag += `<td style="color:black">${diary.month + 1}</td>`;
          tag += `<td style="color:black">${diary.date}</td>`;
          tag += `<td style="color:blue">${diary.title}</td>`;
          tag += "</tr>";
        }
      if(diaryArray.length == 0){
        tag = `<h3 style="textAlign: center">ì¼ì •ì„ ì¶”ê°€í•˜ì„¸ìš”<h3>`;
      }
        
      tag += "</table>";
      document.getElementById("rest-div").innerHTML = tag;
    }
    
    function closeDialog(){
      document.getElementById("dialog").style.display = "none";
    }

    // ê³µíœ´ì¼ ë²„íŠ¼ ëˆ„ë¥¼ ë•Œ ë‚ ì§œ ì¶œë ¥
    function restRoop(){
      document.getElementById("restPrint_btn").addEventListener("click", function(){
          st = 1;
      })
      if(st == 1)
      restPrint();
    }
        
    function diaryRoop(){
      // ê³µíœ´ì¼ ë²„íŠ¼ ëˆ„ë¥¼ ë•Œ ë‚ ì§œ ì¶œë ¥
      document.getElementById("diaryPrint_btn").addEventListener("click", function(){
        st = 2;
      })
      if(st == 2)
      diaryPrint();
    }

    addEventListener("load", function () {
      let d = new Date();
      getCurrentTime(d.getFullYear(), d.getMonth());
      getMiniCurrentTime(d.getFullYear(), d.getMonth());
      printTitle();
      createDayHeaders();
      createCell(); 
      diaryCellPrint(); 

      document.getElementById("food_search").addEventListener("click", function(){
          window.open(
          "http://127.0.0.1:5501/foodSearch.html",
          "_blank",
          "width=750px,height=560px,left=600px,top=138px;"
        );
      })

      document.getElementById("save_diary").addEventListener("click", function(){
        regist();
      });

      setInterval(diaryRoop, 10);
      setInterval(restRoop, 10);


      // ìƒˆ ì°½ ë‹«ê¸° ì´ë²¤íŠ¸ êµ¬í˜„
      document.getElementById("close-dial").addEventListener("click", () => {
        closeDialog();
      });

      document.getElementById("btn-today").addEventListener("click", () => {
        now();
      });

      /* ë¯¸ë‹ˆ ë‹¬ë ¥ ë²„íŠ¼ êµ¬í˜„ */
      document.getElementById("mini_section").addEventListener("click", () =>{
        getCurrentTime(miniCurrentYear, miniCurrentMonth+1);
        prev();
      });
      document.getElementById("mini_prev").addEventListener("click", () =>{
        miniPrev();
      });
       document.getElementById("mini_next").addEventListener("click", () =>{
        miniNext();
      });


      // ê³µíœ´ì¼ JSON ë°ì´í„° ë¹„ë™ê¸°ì‹ Fetchë¡œ ë¶ˆëŸ¬ì˜¤ê¸°
      fetch("./data.txt")
        .then(response => response.text())
        .then(text => {
          let obj = JSON.parse(text);
          restArray = obj.restList;
          printNum();
          printMiniNum();
        })
        .catch(err => {
          console.error("ê³µíœ´ì¼ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨", err);
          printNum(); // ë°ì´í„°ê°€ ì—†ì–´ë„ ì¶œë ¥ì€ í•´ì•¼ í•¨
          printMiniNum();
        });

    }); 
  </script>
</head>
<body>
  <div id="wrapper">
      <div id="header">
        <div class="header-left">
          <span class="logo">ğŸ“… My Calendar</span>
        </div>
        <div>
          <button id="food_search">ë§›ì§‘ê²€ìƒ‰</button>
        </div>
        <div class="header-right">
          <span class="user">í™˜ì˜í•©ë‹ˆë‹¤, í˜„ì§ë‹˜</span>
          <!-- ì¶”í›„ ì•„ì´ì½˜, ì„¤ì • ë©”ë‰´ ì¶”ê°€ ê°€ëŠ¥ -->
        </div>
      </div>
    <div id="container">
      <div id="aside_nav">
        <div id="mini_calendar">
          <div class="mini-header">
            <button class="mini-prev" id="mini_prev">â—€</button>
            <span class="mini-title">2025.05</span>
            <button class="mini-next" id="mini_next">â–¶</button>
          </div>
          <div class="mini-days">
            <div>ì¼</div><div>ì›”</div><div>í™”</div><div>ìˆ˜</div><div>ëª©</div><div>ê¸ˆ</div><div>í† </div>
          </div>
          <div class="mini-grid" id="mini_section">
            <!-- ë‚ ì§œ 1~31ì¼ ë™ì ìœ¼ë¡œ ì¶œë ¥ë  ì˜ˆì • -->
            <!-- <div>1</div><div>2</div>... -->
          </div>
        </div>
        <div>
          <div>
            <button id="restPrint_btn">ê³µíœ´ì¼ ì¶œë ¥</button>
            <button id="diaryPrint_btn">ì¼ì • ì¶œë ¥</button>
            <div id="rest-div">
            </div>
          </div>
        </div>
      </div>

      <div id="content">
        <div id="content_header">
          <div class="left-controls">
            <a href="javascript:prev()">â—€</a>
            <h2>2025.05</h2>
            <a href="javascript:next()">â–¶</a>
            <button id="btn-today">ì˜¤ëŠ˜</button>
          </div>
        </div>
        <div id="date_print" ></div> 
        <div id="content_section">
          <div id="dialog" style="display: none;">
             <div class="mini-popup">
                <h4>ì¼ì •</h4>
                <div class="info">
                  <span class="label">ì œëª©:</span><br />
                  ë‚˜ëŠ”ì œëª©
                </div>
                <div class="info">
                  <span class="label">ì¥ì†Œ:</span><br />
                  ë‚˜ëŠ”ì¥ì†Œ
                </div>
                <div class="info">
                  <span class="label">ë©”ëª¨:</span><br />
                  ë‚˜ëŠ”ë””í…Œì¼
                </div>
                <div id="map" style="width: 100%; height: 300px; margin-top: 10px;"></div>
                <button id="close-dial">ë‹«ê¸°</button>
                <button id="detail-dial">ìƒì„¸ ì •ë³´</button>
            </div>  
          </div>
        </div>
        <div id="holder_header"></div>
        <div id="holder" style="display: none;">
          <form id="event-form" name="form1">
            <h3>ìƒˆë¡œìš´ ì¼ì • ë“±ë¡</h3>

            <label>
              ì œëª©  
              <input type="text" name="title" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" />
            </label>

            <label>
              ì¥ì†Œ  
              <select name="place">
                <option value="">ì¥ì†Œë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                <option value="ê°•ë‚¨êµ¬">ê°•ë‚¨êµ¬</option>
                <option value="ê°•ë™êµ¬">ê°•ë™êµ¬</option>
                <option value="ê°•ë¶êµ¬">ê°•ë¶êµ¬</option>
                <option value="ê°•ì„œêµ¬">ê°•ì„œêµ¬</option>
                <option value="ê´€ì•…êµ¬">ê´€ì•…êµ¬</option>
                <option value="ê´‘ì§„êµ¬">ê´‘ì§„êµ¬</option>
                <option value="êµ¬ë¡œêµ¬">êµ¬ë¡œêµ¬</option>
                <option value="ê¸ˆì²œêµ¬">ê¸ˆì²œêµ¬</option>
                <option value="ë…¸ì›êµ¬">ë…¸ì›êµ¬</option>
                <option value="ë„ë´‰êµ¬">ë„ë´‰êµ¬</option>
                <option value="ë™ëŒ€ë¬¸êµ¬">ë™ëŒ€ë¬¸êµ¬</option>
                <option value="ë™ì‘êµ¬">ë™ì‘êµ¬</option>
                <option value="ë§ˆí¬êµ¬">ë§ˆí¬êµ¬</option>
                <option value="ì„œëŒ€ë¬¸êµ¬">ì„œëŒ€ë¬¸êµ¬</option>
                <option value="ì„œì´ˆêµ¬">ì„œì´ˆêµ¬</option>
                <option value="ì„±ë™êµ¬">ì„±ë™êµ¬</option>
                <option value="ì„±ë¶êµ¬">ì„±ë¶êµ¬</option>
                <option value="ì†¡íŒŒêµ¬">ì†¡íŒŒêµ¬</option>
                <option value="ì–‘ì²œêµ¬">ì–‘ì²œêµ¬</option>
                <option value="ì˜ë“±í¬êµ¬">ì˜ë“±í¬êµ¬</option>
                <option value="ìš©ì‚°êµ¬">ìš©ì‚°êµ¬</option>
                <option value="ì€í‰êµ¬">ì€í‰êµ¬</option>
                <option value="ì¢…ë¡œêµ¬">ì¢…ë¡œêµ¬</option>
                <option value="ì¤‘êµ¬">ì¤‘êµ¬</option>
                <option value="ì¤‘ë‘êµ¬">ì¤‘ë‘êµ¬</option>
              </select>
            </label>

            <label>
              ì¼ì‹œ  
              <div style="display: flex; gap: 5px;">
                <select name="year">
                  <option value="">ë…„</option>
                  <script>
                    currentYear = new Date().getFullYear();
                    for (let y = currentYear - 3; y <= currentYear + 3; y++) {
                      document.write(`<option value="${y}">${y}ë…„</option>`);
                    }
                  </script>
                </select>
                <select name="month">
                  <option value="">ì›”</option>
                  <script>
                    for (let m = 1; m <= 12; m++) {
                      document.write(`<option value="${m}">${m}ì›”</option>`);
                    }
                  </script>
                </select>
                <select name="date">
                  <option value="">ì¼</option>
                  <script>
                    for (let d = 1; d <= 31; d++) {
                      document.write(`<option value="${d}">${d}ì¼</option>`);
                    }
                  </script>
                </select>
              </div>
            </label>
            <label>
              ìƒ‰ìƒ  
              <select name="color">
                <option value="">ìƒ‰ìƒ ì„ íƒí•˜ì„¸ìš”</option>
                <option value="#f28b82">ë¹¨ê°„ìƒ‰</option>
                <option value="#fbbc04">ì£¼í™©ìƒ‰</option>
                <option value="#fff475">ë…¸ë€ìƒ‰</option>
                <option value="#ccff90">ì—°ë‘ìƒ‰</option>
                <option value="#a7ffeb">ë¯¼íŠ¸ìƒ‰</option>
                <option value="#cbf0f8">í•˜ëŠ˜ìƒ‰</option>
                <option value="#aecbfa">íŒŒë€ìƒ‰</option>
                <option value="#d7aefb">ë³´ë¼ìƒ‰</option>
                <option value="#fdcfe8">ë¶„í™ìƒ‰</option>
                <option value="#e6c9a8">ê°ˆìƒ‰</option>
                <option value="#e8eaed">íšŒìƒ‰</option>
              </select>
            </label>

            <label>
              ì„¤ëª…  
              <textarea name="description" rows="5" placeholder="ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
            </label>

            <div class="form-buttons">
              <button type="button" class="save-btn" id="save_diary">âœ” ì €ì¥</button>
              <button type="button" class="update-btn" id="update_diary" style="display: none;">ë³€ê²½</button>
              <button type="button" class="cancel-btn" onclick="form1.reset(); now();">ì·¨ì†Œ</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <div id="footer">
    </div>
  </div>
</body>
</html>
