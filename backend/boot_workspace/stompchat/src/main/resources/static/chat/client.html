<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Document</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</head>
<body>
    <div id="app">
        <h2>Spring WebSocket 기반 채팅</h2>

        <!-- DB 연동하지 않고, 사용자를 직접 입력하여 채팅 -->
        <div v-if="!connected">
            <input type="text" v-model="username" placeholder="채팅 사용자 명 입력" >
            <button type="button" @click="connect()">웹소켓 서버 접속</button>
        </div>

        <div v-else>
            <p><b>{{username}}</b>님 접속중 </p>
            <button type="button" @click="disconnect()">접속 종료</button>

            <div>
                <input type="text" v-model="message" @keyup.enter="sendMessage()" placeholder="메시지 입력하셔요">
                <button type="button" @click="sendMessage()">메시지 전송</button>
            </div>
        </div>

        <h3>총 접속자</h3>
        <ul>
            <li v-for="user in users">{{user}}</li>
        </ul>
        <h3>메시지 로그</h3>
        <ul>
            <li v-for="msg in messages">{{msg.sender}}님의 말 : {{msg.content}}</li>
        </ul>

        <div>
            <input type="text" v-model="roomName" placeholder="방이름 입력">
            <button type="button" @click="createRoom()">방 만들기</button>
        </div>

        <h3>방 목록</h3>
        <ul>
            <li v-for="room in rooms" :key="room.roomId">
                <b>{{room.roomName}}</b> ( 참여자 수 : {{room.users.length}} )
                <ul>
                    <li v-for="user in room.users">{{user}}</li>
                    <button type="button" @click="enterRoom(room.roomId)">참여하기</button>
                    <button type="button" @click="leaveRoom(room.roomId)">나가기</button>
                </ul>
            </li>
        </ul>

    </div>

    <script>
        const {createApp, ref} = Vue;

        createApp({
            setup(){
                const username = ref("");
                const connected = ref(false);
                const users = ref([]);
                const message = ref("");
                const messages = ref([]);
                const roomName = ref("");
                const rooms = ref([]);

                let stompClient = null; // STOMP 클라이언트 객체

                // 웹소켓 서버에 접속 시도
                const connect =()=>{
                    // 채팅 아이디를 입력했을 때만 접속 시도
                    if(!username.value.trim()){
                        alert("채팅 아이디를 입력하세요");
                        return; // 메서드 종료
                    }
                    // 우리의 경우 웹소켓 위에 STOMP를 얹혀 사용할 예정이므로
                    // 반드시 WebSocket이 필요
                    const socket = new WebSocket("ws://localhost:7777/ws");
                    stompClient = Stomp.over(socket); // WebSocket 위에 STOMP 프로토콜 올리기

                    // 서버와 STOMP 연결 시도 ( 헤더 정보 없이 )
                    stompClient.connect({}, ()=>{
                        connected.value = true; // 바인딩 변수를 true로 놓아야 화면 전환

                        // 접속과 동시에 원하는 채널을 구독하자
                        stompClient.subscribe("/topic/users", (msg)=>{
                            users.value = JSON.parse(msg.body);
                        });

                        // 채팅 메시지 구독
                        stompClient.subscribe("/topic/messages", (msg)=>{
                            messages.value.push(JSON.parse(msg.body));
                        })

                        // 방 목록 메시지 구독
                        stompClient.subscribe("/topic/rooms", (msg)=>{
                            rooms.value = JSON.parse(msg.body);
                        })

                        // 서버에 메시지 보내기
                        stompClient.send("/app/connect", {}, JSON.stringify({sender : username.value}));

                        // 접속과 동시에, 방 목록을 요청
                        getRooms();
                    });
                }

                const sendMessage =()=>{
                    if(message.value.trim()){
                       stompClient.send("/app/chat.send", {}, JSON.stringify({
                           sender : username.value,
                           content : message.value
                       }) );
                    }
                }

                const getRooms=()=>{
                    stompClient.send("/app/room.list", {}, {});
                }

                const createRoom=()=>{
                    if(roomName.value.trim()){ // 방제목을 입력한 경우만...
                       stompClient.send("/app/room.create", {}, JSON.stringify({
                           sender : username.value,
                           content : roomName.value
                       }));
                       roomName.value="";
                    }
                }

                const enterRoom=(roomId)=>{
                    stompClient.send("/app/room.enter", {}, JSON.stringify({
                        sender : username.value,
                        roomId : roomId
                    }));
                }

                const leaveRoom=(roomId)=>{
                    stompClient.send("/app/room.leave", {}, JSON.stringify({
                        sender : username.value,
                        roomId : roomId
                    }));
                }

                const disconnect=()=>{
                    // 종료로 인하여 웹소켓이 끊기면 서버가 보내준 구독 브로드캐스팅 정보 조차 받을 수없다.
                    stompClient.send("/app/disconnect", {}, JSON.stringify({
                        sender : username.value
                    }));

                    stompClient.disconnect();

                    let newUsers = [];

                    // 기존 유저 목록이 들어있는 배열에서, 현재 사용자를 제거한 후
                    // 최종 배열을 생성
                    console.log("user.value : " + users.value);
                    for (let i=0; i< users.value.length; i++){
                        if( users.value[i] != username.value ){
                            newUsers.push(users.value[i]);
                        }
                    }
                    users.value = newUsers;

                    connected.value = false;
                }

                return {message, connected, username, users, messages, roomName, rooms,
                    connect, sendMessage, getRooms, createRoom, enterRoom, leaveRoom, disconnect}
            }
        }).mount("#app");

    </script>
</body>
</html>
